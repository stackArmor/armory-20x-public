import{t as e,y as ae,R as N,B as oe,v as le}from"./index-cMNJPoS_.js";import{g as R,C as I,S as L,u as ne,A as ie}from"./HelpIcon-BDXI7Ygg.js";import{t as ce,o as de,c as ue,a as he,b as me,G as xe,K as je,d as ge}from"./KsiWidgets-BtKqfeDr.js";import{j as fe,u as U,a5 as W,k as B,s as J,I as Q,l as Y,m as Z,a6 as ee,B as O,n as ve,q as A,x as pe,y as ye,L as _,X as se,a0 as we,T as k,a4 as K,a7 as Ce,S as P,a3 as Te}from"./dashboardStore-nygBH_uz.js";import{T as be,I as Se,a as Be,u as Ge}from"./IconSearch-Dmm0wqgn.js";import{T as u}from"./Table-ONRllMQO.js";import{B as $}from"./IconSettings-Dmm99b5x.js";import{D as qe}from"./Drawer-BtgfIXyR.js";const[V,te]=fe("Grid component was not found in tree"),z=(s,a)=>s==="content"?"auto":s==="auto"?"0rem":s?`${100/(a/s)}%`:void 0,M=(s,a,l)=>l||s==="auto"?"100%":s==="content"?"unset":z(s,a),E=(s,a)=>{if(s)return s==="auto"||a?"1":"auto"},H=(s,a)=>s===0?"0":s?`${100/(a/s)}%`:void 0;function Re({span:s,order:a,offset:l,selector:r}){var v;const j=U(),o=te(),m=o.breakpoints||j.breakpoints,h=R(s)===void 0?12:R(s),f=W({"--col-order":(v=R(a))==null?void 0:v.toString(),"--col-flex-grow":E(h,o.grow),"--col-flex-basis":z(h,o.columns),"--col-width":h==="content"?"auto":void 0,"--col-max-width":M(h,o.columns,o.grow),"--col-offset":H(R(l),o.columns)}),i=B(m).reduce((c,n)=>{var C;return c[n]||(c[n]={}),typeof a=="object"&&a[n]!==void 0&&(c[n]["--col-order"]=(C=a[n])==null?void 0:C.toString()),typeof s=="object"&&s[n]!==void 0&&(c[n]["--col-flex-grow"]=E(s[n],o.grow),c[n]["--col-flex-basis"]=z(s[n],o.columns),c[n]["--col-width"]=s[n]==="content"?"auto":void 0,c[n]["--col-max-width"]=M(s[n],o.columns,o.grow)),typeof l=="object"&&l[n]!==void 0&&(c[n]["--col-offset"]=H(l[n],o.columns)),c},{}),S=J(B(i),m).filter(c=>B(i[c.value]).length>0).map(c=>({query:o.type==="container"?`mantine-grid (min-width: ${m[c.value]})`:`(min-width: ${m[c.value]})`,styles:i[c.value]}));return e.jsx(Q,{styles:f,media:o.type==="container"?void 0:S,container:o.type==="container"?S:void 0,selector:r})}var D={container:"m_8478a6da",root:"m_410352e9",inner:"m_dee7bd2f",col:"m_96bdd299"};const ke={span:12},F=Y((s,a)=>{const l=Z("GridCol",ke,s),{classNames:r,className:j,style:o,styles:m,vars:w,span:h,order:f,offset:i,...g}=l,S=te(),v=ee();return e.jsxs(e.Fragment,{children:[e.jsx(Re,{selector:`.${v}`,span:h,order:f,offset:i}),e.jsx(O,{ref:a,...S.getStyles("col",{className:ve(j,v),style:o,classNames:r,styles:m}),...g})]})});F.classes=D;F.displayName="@mantine/core/GridCol";function X({gutter:s,selector:a,breakpoints:l,type:r}){const j=U(),o=l||j.breakpoints,m=W({"--grid-gutter":A(R(s))}),w=B(o).reduce((i,g)=>(i[g]||(i[g]={}),typeof s=="object"&&s[g]!==void 0&&(i[g]["--grid-gutter"]=A(s[g])),i),{}),f=J(B(w),o).filter(i=>B(w[i.value]).length>0).map(i=>({query:r==="container"?`mantine-grid (min-width: ${o[i.value]})`:`(min-width: ${o[i.value]})`,styles:w[i.value]}));return e.jsx(Q,{styles:m,media:r==="container"?void 0:f,container:r==="container"?f:void 0,selector:a})}const Ne={gutter:"md",grow:!1,columns:12},Ke=ye((s,{justify:a,align:l,overflow:r})=>({root:{"--grid-justify":a,"--grid-align":l,"--grid-overflow":r}})),G=Y((s,a)=>{const l=Z("Grid",Ne,s),{classNames:r,className:j,style:o,styles:m,unstyled:w,vars:h,grow:f,gutter:i,columns:g,align:S,justify:v,children:c,breakpoints:n,type:C,attributes:T,...q}=l,p=pe({name:"Grid",classes:D,props:l,className:j,style:o,classNames:r,styles:m,unstyled:w,attributes:T,vars:h,varsResolver:Ke}),b=ee();return C==="container"&&n?e.jsxs(V,{value:{getStyles:p,grow:f,columns:g,breakpoints:n,type:C},children:[e.jsx(X,{selector:`.${b}`,...l}),e.jsx("div",{...p("container"),children:e.jsx(O,{ref:a,...p("root",{className:b}),...q,children:e.jsx("div",{...p("inner"),children:c})})})]}):e.jsxs(V,{value:{getStyles:p,grow:f,columns:g,breakpoints:n,type:C},children:[e.jsx(X,{selector:`.${b}`,...l}),e.jsx(O,{ref:a,...p("root",{className:b}),...q,children:e.jsx("div",{...p("inner"),children:c})})]})});G.classes=D;G.displayName="@mantine/core/Grid";G.Col=F;function Pe({value:s,onChange:a,onClear:l}){return e.jsx(I,{withBorder:!0,padding:"md",radius:"md",children:e.jsxs(_,{justify:"space-between",align:"center",children:[e.jsxs(_,{children:[e.jsx(be,{leftSection:e.jsx(Se,{size:16}),placeholder:"Search KSI families…",value:s.q,onChange:r=>a({q:r.currentTarget.value})}),e.jsx(L,{placeholder:"Filter status",data:[{value:"alarm",label:"Has Alarm"},{value:"error",label:"Has Error"},{value:"ok",label:"All OK"}],value:s.status,onChange:r=>a({status:r}),clearable:!0,leftSection:e.jsx(Be,{size:16})}),e.jsx(L,{placeholder:"Sort by",data:[{value:"okrate-desc",label:"OK rate (high→low)"},{value:"okrate-asc",label:"OK rate (low→high)"},{value:"total-desc",label:"Total (high→low)"},{value:"total-asc",label:"Total (low→high)"}],value:s.sort,onChange:r=>a({sort:r||"okrate-desc"})})]}),(s.q||s.status)&&e.jsx(se,{variant:"subtle",leftSection:e.jsx(we,{size:16}),onClick:l,children:"Clear"})]})})}function $e({groups:s,onRowClick:a}){return e.jsxs(u,{striped:!0,highlightOnHover:!0,withRowBorders:!1,verticalSpacing:"sm",children:[e.jsx(u.Thead,{children:e.jsxs(u.Tr,{children:[e.jsx(u.Th,{children:"Category"}),e.jsx(u.Th,{children:"Total"}),e.jsx(u.Th,{children:"OK"}),e.jsx(u.Th,{children:"Alarm"}),e.jsx(u.Th,{children:"Error"}),e.jsx(u.Th,{children:"OK Rate"})]})}),e.jsx(u.Tbody,{children:s.map(l=>{var m;const r=(m=l.summary)==null?void 0:m.status,j=ce(r),o=Math.round(de(r));return e.jsxs(u.Tr,{onClick:()=>a(l),style:{cursor:"pointer"},children:[e.jsx(u.Td,{children:e.jsxs("div",{children:[e.jsx(k,{fw:500,children:ue(l.title)}),l.description&&e.jsx(k,{c:"dimmed",size:"sm",mt:4,lineClamp:2,children:he(l.description)})]})}),e.jsx(u.Td,{children:j}),e.jsx(u.Td,{children:(r==null?void 0:r.ok)??0}),e.jsx(u.Td,{children:e.jsx($,{color:"red",variant:"light",children:(r==null?void 0:r.alarm)??0})}),e.jsx(u.Td,{children:e.jsx($,{color:"grape",variant:"light",children:(r==null?void 0:r.error)??0})}),e.jsx(u.Td,{children:e.jsxs($,{color:o>=90?"teal":o>=70?"yellow":"red",children:[o,"%"]})})]},l.group_id)})})]})}const Me=ae(function(){const{data:a,loading:l,error:r,ksiCategories:j}=ne(),[o,{open:m,close:w}]=Ge(!1),[h,f]=N.useState(null),[i,g]=oe(),S=le(),v=i.get("q")??"",c=i.get("status"),n=i.get("sort")??"okrate-desc",C=i.get("view")??"cards";function T(t,d,x=!1){const y=new URLSearchParams(i);d===null||d===""?y.delete(t):y.set(t,d),g(y,{replace:!0,preventScrollReset:x})}function q(t){f(t),m()}const p=N.useMemo(()=>me(j),[j]),b=N.useMemo(()=>{let t=p;if(v){const d=v.toLowerCase();t=t.filter(x=>x.title.toLowerCase().includes(d)||x.description.toLowerCase().includes(d))}if(c){const d=new Set(c.split(",").filter(Boolean));t=t.filter(x=>{const y=x.status;return y?[d.has("alarm")&&(y.alarm??0)>0,d.has("error")&&(y.error??0)>0,d.has("ok")&&(y.ok??0)>0&&(y.alarm??0)===0&&(y.error??0)===0].some(Boolean):!1})}switch(n){case"okrate-desc":t=[...t].sort((d,x)=>(x.okRate??0)-(d.okRate??0));break;case"okrate-asc":t=[...t].sort((d,x)=>(d.okRate??0)-(x.okRate??0));break;case"total-desc":t=[...t].sort((d,x)=>(x.total??0)-(d.total??0));break;case"total-asc":t=[...t].sort((d,x)=>(d.total??0)-(x.total??0));break}return t},[p,v,c,n]);if(l)return e.jsx(K,{size:"lg",py:"xl",children:e.jsxs(_,{justify:"center",mt:"xl",children:[e.jsx(Ce,{}),e.jsx(k,{children:"Loading KSI results…"})]})});if(r||!a)return e.jsx(K,{size:"lg",py:"xl",children:e.jsx(ie,{color:"red",title:"Failed to load data",variant:"light",children:r||"No data available"})});const re={q:v,status:c??null,sort:n};return e.jsxs(K,{size:"xl",py:"lg",children:[e.jsxs(P,{gap:"lg",children:[e.jsx(xe,{categories:j}),e.jsx(Te,{value:C,onChange:t=>T("view",t,!0),data:[{label:"Cards",value:"cards"},{label:"Table",value:"table"}]}),e.jsx(Pe,{value:re,onChange:t=>{t.q!==void 0&&T("q",t.q),t.status!==void 0&&T("status",t.status),t.sort!==void 0&&T("sort",t.sort)},onClear:()=>{T("q",null),T("status",null)}}),C==="cards"?e.jsxs(G,{children:[b.map(t=>e.jsx(G.Col,{span:{base:12,sm:6,md:4},children:e.jsx(je,{group:t.group,onOpen:d=>q(d)})},t.id)),b.length===0&&e.jsx(G.Col,{span:12,children:e.jsx(I,{withBorder:!0,children:e.jsx(P,{align:"center",py:"lg",children:e.jsx(k,{c:"dimmed",children:"No KSI families match your filters."})})})})]}):e.jsx(I,{withBorder:!0,children:e.jsx($e,{groups:b.map(t=>t.group),onRowClick:t=>q(t)})})]}),e.jsx(qe,{opened:o,onClose:w,title:h==null?void 0:h.title,position:"right",size:"lg",children:e.jsxs(P,{children:[h&&e.jsx(se,{variant:"light",onClick:()=>S(`/${h.group_id}`),children:"Open full details"}),e.jsx(ge,{group:h})]})})]})});export{Me as default};
