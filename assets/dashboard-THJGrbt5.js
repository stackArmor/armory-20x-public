import{t as e,y as de,R as N,B as ue,v as he}from"./index-cMNJPoS_.js";import{g as R,C as I,u as me,A as xe}from"./HelpIcon-_nQLatLy.js";import{t as ge,o as je,c as fe,a as ve,b as pe,G as ye,K as Ce,d as we}from"./KsiWidgets-CoX_nqKv.js";import{j as Te,u as Z,a7 as ee,k as B,s as se,I as te,l as re,m as ae,a8 as oe,B as O,n as be,q as H,x as Se,y as Be,Q as _,_ as le,a3 as Ge,T as k,a6 as P,a9 as qe,P as K}from"./middleware-B3r9d54z.js";import{T as Re,a as ke,u as Ne}from"./IconSearch-DKevmGIS.js";import{S as Q,I as Pe,T as u,a as Ke}from"./IconFilter-DtHJncli.js";import{B as $}from"./dashboardStore-GjhsmBeZ.js";import{D as $e}from"./Drawer-1-RJdAfa.js";const[U,ne]=Te("Grid component was not found in tree"),z=(s,a)=>s==="content"?"auto":s==="auto"?"0rem":s?`${100/(a/s)}%`:void 0,W=(s,a,l)=>l||s==="auto"?"100%":s==="content"?"unset":z(s,a),X=(s,a)=>{if(s)return s==="auto"||a?"1":"auto"},J=(s,a)=>s===0?"0":s?`${100/(a/s)}%`:void 0;function Ie({span:s,order:a,offset:l,selector:r}){var p;const g=Z(),o=ne(),m=o.breakpoints||g.breakpoints,h=R(s)===void 0?12:R(s),v=ee({"--col-order":(p=R(a))==null?void 0:p.toString(),"--col-flex-grow":X(h,o.grow),"--col-flex-basis":z(h,o.columns),"--col-width":h==="content"?"auto":void 0,"--col-max-width":W(h,o.columns,o.grow),"--col-offset":J(R(l),o.columns)}),i=B(m).reduce((c,n)=>{var w;return c[n]||(c[n]={}),typeof a=="object"&&a[n]!==void 0&&(c[n]["--col-order"]=(w=a[n])==null?void 0:w.toString()),typeof s=="object"&&s[n]!==void 0&&(c[n]["--col-flex-grow"]=X(s[n],o.grow),c[n]["--col-flex-basis"]=z(s[n],o.columns),c[n]["--col-width"]=s[n]==="content"?"auto":void 0,c[n]["--col-max-width"]=W(s[n],o.columns,o.grow)),typeof l=="object"&&l[n]!==void 0&&(c[n]["--col-offset"]=J(l[n],o.columns)),c},{}),S=se(B(i),m).filter(c=>B(i[c.value]).length>0).map(c=>({query:o.type==="container"?`mantine-grid (min-width: ${m[c.value]})`:`(min-width: ${m[c.value]})`,styles:i[c.value]}));return e.jsx(te,{styles:v,media:o.type==="container"?void 0:S,container:o.type==="container"?S:void 0,selector:r})}var D={container:"m_8478a6da",root:"m_410352e9",inner:"m_dee7bd2f",col:"m_96bdd299"};const Oe={span:12},F=re((s,a)=>{const l=ae("GridCol",Oe,s),{classNames:r,className:g,style:o,styles:m,vars:C,span:h,order:v,offset:i,...j}=l,S=ne(),p=oe();return e.jsxs(e.Fragment,{children:[e.jsx(Ie,{selector:`.${p}`,span:h,order:v,offset:i}),e.jsx(O,{ref:a,...S.getStyles("col",{className:be(g,p),style:o,classNames:r,styles:m}),...j})]})});F.classes=D;F.displayName="@mantine/core/GridCol";function Y({gutter:s,selector:a,breakpoints:l,type:r}){const g=Z(),o=l||g.breakpoints,m=ee({"--grid-gutter":H(R(s))}),C=B(o).reduce((i,j)=>(i[j]||(i[j]={}),typeof s=="object"&&s[j]!==void 0&&(i[j]["--grid-gutter"]=H(s[j])),i),{}),v=se(B(C),o).filter(i=>B(C[i.value]).length>0).map(i=>({query:r==="container"?`mantine-grid (min-width: ${o[i.value]})`:`(min-width: ${o[i.value]})`,styles:C[i.value]}));return e.jsx(te,{styles:m,media:r==="container"?void 0:v,container:r==="container"?v:void 0,selector:a})}const _e={gutter:"md",grow:!1,columns:12},ze=Be((s,{justify:a,align:l,overflow:r})=>({root:{"--grid-justify":a,"--grid-align":l,"--grid-overflow":r}})),G=re((s,a)=>{const l=ae("Grid",_e,s),{classNames:r,className:g,style:o,styles:m,unstyled:C,vars:h,grow:v,gutter:i,columns:j,align:S,justify:p,children:c,breakpoints:n,type:w,attributes:T,...q}=l,y=Se({name:"Grid",classes:D,props:l,className:g,style:o,classNames:r,styles:m,unstyled:C,attributes:T,vars:h,varsResolver:ze}),b=oe();return w==="container"&&n?e.jsxs(U,{value:{getStyles:y,grow:v,columns:j,breakpoints:n,type:w},children:[e.jsx(Y,{selector:`.${b}`,...l}),e.jsx("div",{...y("container"),children:e.jsx(O,{ref:a,...y("root",{className:b}),...q,children:e.jsx("div",{...y("inner"),children:c})})})]}):e.jsxs(U,{value:{getStyles:y,grow:v,columns:j,breakpoints:n,type:w},children:[e.jsx(Y,{selector:`.${b}`,...l}),e.jsx(O,{ref:a,...y("root",{className:b}),...q,children:e.jsx("div",{...y("inner"),children:c})})]})});G.classes=D;G.displayName="@mantine/core/Grid";G.Col=F;function De({value:s,onChange:a,onClear:l}){return e.jsx(I,{withBorder:!0,padding:"md",radius:"md",children:e.jsxs(_,{justify:"space-between",align:"center",children:[e.jsxs(_,{children:[e.jsx(Re,{leftSection:e.jsx(ke,{size:16}),placeholder:"Search KSI families…",value:s.q,onChange:r=>a({q:r.currentTarget.value})}),e.jsx(Q,{placeholder:"Filter status",data:[{value:"alarm",label:"Has Alarm"},{value:"error",label:"Has Error"},{value:"ok",label:"All OK"}],value:s.status,onChange:r=>a({status:r}),clearable:!0,leftSection:e.jsx(Pe,{size:16})}),e.jsx(Q,{placeholder:"Sort by",data:[{value:"okrate-desc",label:"OK rate (high→low)"},{value:"okrate-asc",label:"OK rate (low→high)"},{value:"total-desc",label:"Total (high→low)"},{value:"total-asc",label:"Total (low→high)"}],value:s.sort,onChange:r=>a({sort:r||"okrate-desc"})})]}),(s.q||s.status)&&e.jsx(le,{variant:"subtle",leftSection:e.jsx(Ge,{size:16}),onClick:l,children:"Clear"})]})})}function Fe({groups:s,onRowClick:a}){return e.jsxs(u,{striped:!0,highlightOnHover:!0,withRowBorders:!1,verticalSpacing:"sm",children:[e.jsx(u.Thead,{children:e.jsxs(u.Tr,{children:[e.jsx(u.Th,{children:"Category"}),e.jsx(u.Th,{children:"Total"}),e.jsx(u.Th,{children:"OK"}),e.jsx(u.Th,{children:"Alarm"}),e.jsx(u.Th,{children:"Error"}),e.jsx(u.Th,{children:"OK Rate"})]})}),e.jsx(u.Tbody,{children:s.map(l=>{var m;const r=(m=l.summary)==null?void 0:m.status,g=ge(r),o=Math.round(je(r));return e.jsxs(u.Tr,{onClick:()=>a(l),style:{cursor:"pointer"},children:[e.jsx(u.Td,{children:e.jsxs("div",{children:[e.jsx(k,{fw:500,children:fe(l.title)}),l.description&&e.jsx(k,{c:"dimmed",size:"sm",mt:4,lineClamp:2,children:ve(l.description)})]})}),e.jsx(u.Td,{children:g}),e.jsx(u.Td,{children:(r==null?void 0:r.ok)??0}),e.jsx(u.Td,{children:e.jsx($,{color:"red",variant:"light",children:(r==null?void 0:r.alarm)??0})}),e.jsx(u.Td,{children:e.jsx($,{color:"grape",variant:"light",children:(r==null?void 0:r.error)??0})}),e.jsx(u.Td,{children:e.jsxs($,{color:o>=90?"teal":o>=70?"yellow":"red",children:[o,"%"]})})]},l.group_id)})})]})}const We=de(function(){const{data:a,loading:l,error:r,ksiCategories:g}=me(),[o,{open:m,close:C}]=Ne(!1),[h,v]=N.useState(null),[i,j]=ue(),S=he(),p=i.get("q")??"",c=i.get("status"),n=i.get("sort")??"okrate-desc",w=i.get("view")??"cards";function T(t,d,x=!1){const f=new URLSearchParams(i);d===null||d===""?f.delete(t):f.set(t,d),j(f,{replace:!0,preventScrollReset:x})}function q(t){v(t),m()}const y=N.useMemo(()=>pe(g),[g]),b=N.useMemo(()=>{let t=y;if(p){const d=p.toLowerCase();t=t.filter(x=>{var L,A,V,E;const f=((L=x.title)==null?void 0:L.toLowerCase().includes(d))??!1,M=((A=x.description)==null?void 0:A.toLowerCase().includes(d))??!1,ce=((E=(V=x.group)==null?void 0:V.title)==null?void 0:E.toLowerCase().includes(d))??!1;return f||M||ce})}if(c){const d=new Set(c.split(",").filter(Boolean));t=t.filter(x=>{const f=x.status;return f?[d.has("alarm")&&(f.alarm??0)>0,d.has("error")&&(f.error??0)>0,d.has("ok")&&(f.ok??0)>0&&(f.alarm??0)===0&&(f.error??0)===0].some(Boolean):!1})}switch(n){case"okrate-desc":t=[...t].sort((d,x)=>(x.okRate??0)-(d.okRate??0));break;case"okrate-asc":t=[...t].sort((d,x)=>(d.okRate??0)-(x.okRate??0));break;case"total-desc":t=[...t].sort((d,x)=>(x.total??0)-(d.total??0));break;case"total-asc":t=[...t].sort((d,x)=>(d.total??0)-(x.total??0));break}return t},[y,p,c,n]);if(l)return e.jsx(P,{size:"lg",py:"xl",children:e.jsxs(_,{justify:"center",mt:"xl",children:[e.jsx(qe,{}),e.jsx(k,{children:"Loading KSI results…"})]})});if(r||!a)return e.jsx(P,{size:"lg",py:"xl",children:e.jsx(xe,{color:"red",title:"Failed to load data",variant:"light",children:r||"No data available"})});const ie={q:p,status:c??null,sort:n};return e.jsxs(P,{size:"xl",py:"lg",children:[e.jsxs(K,{gap:"lg",children:[e.jsx(ye,{categories:g}),e.jsx(Ke,{value:w,onChange:t=>T("view",t,!0),data:[{label:"Cards",value:"cards"},{label:"Table",value:"table"}]}),e.jsx(De,{value:ie,onChange:t=>{t.q!==void 0&&T("q",t.q,!0),t.status!==void 0&&T("status",t.status,!0),t.sort!==void 0&&T("sort",t.sort,!0)},onClear:()=>{T("q",null,!0),T("status",null,!0)}}),w==="cards"?e.jsxs(G,{children:[b.map(t=>e.jsx(G.Col,{span:{base:12,sm:6,md:4},children:e.jsx(Ce,{group:t.group,onOpen:d=>q(d)})},t.id)),b.length===0&&e.jsx(G.Col,{span:12,children:e.jsx(I,{withBorder:!0,children:e.jsx(K,{align:"center",py:"lg",children:e.jsx(k,{c:"dimmed",children:"No KSI families match your filters."})})})})]}):e.jsx(I,{withBorder:!0,children:e.jsx(Fe,{groups:b.map(t=>t.group),onRowClick:t=>q(t)})})]}),e.jsx($e,{opened:o,onClose:C,title:h==null?void 0:h.title,position:"right",size:"lg",children:e.jsxs(K,{children:[h&&e.jsx(le,{variant:"light",onClick:()=>S(`/${h.group_id}`),children:"Open full details"}),e.jsx(we,{group:h})]})})]})});export{We as default};
