import{p as e,v as P,R as T,A as F,q as E}from"./chunk-C37GKA54-CG9TNitP.js";import{u as H,A as M}from"./HelpIcon-C1bK2S4u.js";import{t as N,o as _,c as $,a as J,b as U,G as X,K as Z,d as Q}from"./KsiWidgets-Dh61_LEF.js";import{C as y,S as O}from"./Select-CheMonxa.js";import{J as R,R as z,Z as V,T as f,$ as v,a0 as W,S as k}from"./dashboardStore-j1afM62Q.js";import{T as Y,I as ee,a as se,u as re}from"./IconSearch-DEKIV24a.js";import{T as a}from"./Table-CI8EG-wr.js";import{B as w}from"./IconSettings-CTxfJ391.js";import{S as te}from"./IconHelp-BOZOBTM8.js";import{G as S}from"./Grid-B01PR-LB.js";import{D as ae}from"./Drawer-BrJtq_42.js";import"./IconCheck-BdoyRWHd.js";import"./PieChart-e3iealr6.js";import"./index-bL05S6fw.js";function le({value:n,onChange:c,onClear:o}){return e.jsx(y,{withBorder:!0,padding:"md",radius:"md",children:e.jsxs(R,{justify:"space-between",align:"center",children:[e.jsxs(R,{children:[e.jsx(Y,{leftSection:e.jsx(ee,{size:16}),placeholder:"Search KSI families…",value:n.q,onChange:r=>c({q:r.currentTarget.value})}),e.jsx(O,{placeholder:"Filter status",data:[{value:"alarm",label:"Has Alarm"},{value:"error",label:"Has Error"},{value:"ok",label:"All OK"}],value:n.status,onChange:r=>c({status:r}),clearable:!0,leftSection:e.jsx(se,{size:16})}),e.jsx(O,{placeholder:"Sort by",data:[{value:"okrate-desc",label:"OK rate (high→low)"},{value:"okrate-asc",label:"OK rate (low→high)"},{value:"total-desc",label:"Total (high→low)"},{value:"total-asc",label:"Total (low→high)"}],value:n.sort,onChange:r=>c({sort:r||"okrate-desc"})})]}),(n.q||n.status)&&e.jsx(z,{variant:"subtle",leftSection:e.jsx(V,{size:16}),onClick:o,children:"Clear"})]})})}function oe({groups:n,onRowClick:c}){return e.jsxs(a,{striped:!0,highlightOnHover:!0,withRowBorders:!1,verticalSpacing:"sm",children:[e.jsx(a.Thead,{children:e.jsxs(a.Tr,{children:[e.jsx(a.Th,{children:"Category"}),e.jsx(a.Th,{children:"Total"}),e.jsx(a.Th,{children:"OK"}),e.jsx(a.Th,{children:"Alarm"}),e.jsx(a.Th,{children:"Error"}),e.jsx(a.Th,{children:"OK Rate"})]})}),e.jsx(a.Tbody,{children:n.map(o=>{var x;const r=(x=o.summary)==null?void 0:x.status,u=N(r),m=Math.round(_(r));return e.jsxs(a.Tr,{onClick:()=>c(o),style:{cursor:"pointer"},children:[e.jsx(a.Td,{children:e.jsxs("div",{children:[e.jsx(f,{fw:500,children:$(o.title)}),o.description&&e.jsx(f,{c:"dimmed",size:"sm",mt:4,lineClamp:2,children:J(o.description)})]})}),e.jsx(a.Td,{children:u}),e.jsx(a.Td,{children:(r==null?void 0:r.ok)??0}),e.jsx(a.Td,{children:e.jsx(w,{color:"red",variant:"light",children:(r==null?void 0:r.alarm)??0})}),e.jsx(a.Td,{children:e.jsx(w,{color:"grape",variant:"light",children:(r==null?void 0:r.error)??0})}),e.jsx(a.Td,{children:e.jsxs(w,{color:m>=90?"teal":m>=70?"yellow":"red",children:[m,"%"]})})]},o.group_id)})})]})}const ve=P(function(){const{data:c,loading:o,error:r,ksiCategories:u}=H(),[m,{open:x,close:D}]=re(!1),[d,I]=T.useState(null),[p,A]=F(),G=E(),j=p.get("q")??"",g=p.get("status"),b=p.get("sort")??"okrate-desc",q=p.get("view")??"cards";function h(s,t,l=!1){const i=new URLSearchParams(p);t===null||t===""?i.delete(s):i.set(s,t),A(i,{replace:!0,preventScrollReset:l})}function K(s){I(s),x()}const B=T.useMemo(()=>U(u),[u]),C=T.useMemo(()=>{let s=B;if(j){const t=j.toLowerCase();s=s.filter(l=>l.title.toLowerCase().includes(t)||l.description.toLowerCase().includes(t))}if(g){const t=new Set(g.split(",").filter(Boolean));s=s.filter(l=>{const i=l.status;return i?[t.has("alarm")&&(i.alarm??0)>0,t.has("error")&&(i.error??0)>0,t.has("ok")&&(i.ok??0)>0&&(i.alarm??0)===0&&(i.error??0)===0].some(Boolean):!1})}switch(b){case"okrate-desc":s=[...s].sort((t,l)=>(l.okRate??0)-(t.okRate??0));break;case"okrate-asc":s=[...s].sort((t,l)=>(t.okRate??0)-(l.okRate??0));break;case"total-desc":s=[...s].sort((t,l)=>(l.total??0)-(t.total??0));break;case"total-asc":s=[...s].sort((t,l)=>(t.total??0)-(l.total??0));break}return s},[B,j,g,b]);if(o)return e.jsx(v,{size:"lg",py:"xl",children:e.jsxs(R,{justify:"center",mt:"xl",children:[e.jsx(W,{}),e.jsx(f,{children:"Loading KSI results…"})]})});if(r||!c)return e.jsx(v,{size:"lg",py:"xl",children:e.jsx(M,{color:"red",title:"Failed to load data",variant:"light",children:r||"No data available"})});const L={q:j,status:g??null,sort:b};return e.jsxs(v,{size:"xl",py:"lg",children:[e.jsxs(k,{gap:"lg",children:[e.jsx(X,{categories:u}),e.jsx(te,{value:q,onChange:s=>h("view",s,!0),data:[{label:"Cards",value:"cards"},{label:"Table",value:"table"}]}),e.jsx(le,{value:L,onChange:s=>{s.q!==void 0&&h("q",s.q),s.status!==void 0&&h("status",s.status),s.sort!==void 0&&h("sort",s.sort)},onClear:()=>{h("q",null),h("status",null)}}),q==="cards"?e.jsxs(S,{children:[C.map(s=>e.jsx(S.Col,{span:{base:12,sm:6,md:4},children:e.jsx(Z,{group:s.group,onOpen:t=>K(t)})},s.id)),C.length===0&&e.jsx(S.Col,{span:12,children:e.jsx(y,{withBorder:!0,children:e.jsx(k,{align:"center",py:"lg",children:e.jsx(f,{c:"dimmed",children:"No KSI families match your filters."})})})})]}):e.jsx(y,{withBorder:!0,children:e.jsx(oe,{groups:C.map(s=>s.group),onRowClick:s=>K(s)})})]}),e.jsx(ae,{opened:m,onClose:D,title:d==null?void 0:d.title,position:"right",size:"lg",children:e.jsxs(k,{children:[d&&e.jsx(z,{variant:"light",onClick:()=>G(`/dashboard/${d.group_id}`),children:"Open full details"}),e.jsx(Q,{group:d})]})})]})});export{ve as default};
